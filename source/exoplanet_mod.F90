
module exoplanet_mod
  ! This is paired down version of exoplanet_mod.F90, the primary version of which is
  ! the core module for changing geophysical and stellar parameters in ExoCAM.
  ! This module has been simplified to remove items not explicitly needed in the
  ! standalone radiation.

  ! set basic atmosphere assumptions here.

  use shr_kind_mod,  only: r8 => shr_kind_r8
  implicit none
  public

  ! solar file directory
  character(len=256), parameter :: dirsol = 'data/solar/'

  ! Radiation Spectral Band Optimization
  logical, parameter :: do_exo_rt_optimize_bands = .true.
  real(r8), parameter :: Tmax = 400.          !! Maximum expected temperature for thermal band optimization
  real(r8), parameter :: swFluxLimit = 0.999  !! Fraction of stellar flux captured in bands, rescaled
  real(r8), parameter :: lwFluxLimit = 0.999  !! Fraction of thermal flux captured in bands, not rescaled

  ! solar spectral file names
  !character(len=256), parameter :: solar_file = 'WD_5000K_n84.nc'
  !character(len=256), parameter :: solar_file = 'trappist1_lincowski2018_n68.nc'
  !character(len=256), parameter :: solar_file = 'blackbody_3400K_n28.nc'
  character(len=256), parameter :: solar_file = 'G2V_SUN_n68.nc'
  !character(len=256), parameter :: solar_file = 'LHS1140_spectra_n42.nc'
  !character(len=256), parameter :: solar_file = 'bt-settl_2600_logg4.5_FeH0_n68.nc'

  ! solar constant, 1D kludge
  ! in 1D code, we use the true solar constant divided by 2
  ! a second factor of 2 comes with a 0.5 zenith angle.
  ! Thus 1360 Wm-2 --> 680 Wm-2 --> 340 Wm-2 in the standard SW profile
  real(r8), parameter :: shr_const_scon = 680.0  !Wm-2, Current Earth (approximate)
  !real(r8), parameter :: shr_const_scon = 451.166 !Wm-2, Early Mars

  ! number of levels
  !integer, parameter :: exo_pver   = 40  !CESM
  !integer, parameter :: exo_pver   = 45  !CESM
  !integer, parameter :: exo_pver   = 66  !WACCM
  !integer, parameter :: exo_pver   = 49  !US1976
  !integer, parameter :: exo_pver   = 69   !2 bar CO2
  integer, parameter :: exo_pver   = 300 !ExoMIP

  ! must set gravity!!!!
   !real(r8), parameter :: exo_g = 9.80616 !Earth
  !real(r8), parameter :: exo_g = 7.22925 !Trappist-1e
  !real(r8), parameter :: exo_g = 3.711 ! Mars
    real(r8), parameter :: exo_g = 3.72 ! Mars

  ! Reference pressures (should not effect final answer)
   ! real(r8), parameter :: exo_pstd = 100000.  !Pascals

   !! ========================================================== !!
   !! ====================== RUN OPTIONS ======================= !!
   !! ========================================================== !!
   logical, public, parameter :: do_exo_atmconst = .true.        !! Read gas constituents of atmosphere from this file
                                                                 !! Overrides ghg namelist options
   logical, public, parameter :: do_exo_rt = .true.              !! .true. = use correlated-k "exoplanet" RT
                                                                !! .false. = use CAM4 RT, refer elsewhere for operating
                                                                 !! (currently only works for true.  delete option?)
   logical, public, parameter :: do_exo_synchronous = .false.    !! Toggle to synchronous rotation mode
                                                                 !! Eventually replace with better orbital computer
   logical, public, parameter :: do_exo_rt_clearsky = .false.    !! Do parallel clearsky radiative calculation for exo rt
                                                                 !! Slow, use sparingly
   logical, public, parameter :: do_exo_rt_spectral = .false.    !! collect and output spectrally resolved radiative fluxes
                                                                 !!
   integer, public, parameter :: exo_rad_step = 4 ! 4                !! freq. of radiation calc in time steps (positive)
                                                                 !! or hours (negative).
   logical, public, parameter :: do_carma_exort = .false.        !! Set to true only if running with the CARMA microphyiscs package
                                                                 !! and linking aerosol absorption to ExoRT
   logical, public, parameter :: do_exo_gw = .false.             !! flag to turn on gravity waves.  Note, present gw wave parameterization
                                                                 !! does not work for low pressure atmospheres.
   logical, public, parameter :: do_exo_condense_co2 = .true.    !! flag to condense co2 on surface and in atmosphere
                                                                 !! Must add an advected constituent at build
                                                                 !! -nadv 4 (Q, CLDLIQ, CLDICE, CLDCO2)
   logical, public, parameter :: do_exo_co2cld_rad = .true.      !! include CO2 cloud in radiative transfer calculation
                                                                 !! false implies transparent clouds
   logical, public, parameter :: do_exo_soilcp = .true.          !! use soil heat capacity and bulk density set here



   !! ==============  planet parameters ============== !!
   !! It is the responsibility of the USER to set do_exo_synchronous, exo_ndays
   !! exo_sdays, exo_scon, and exo_solar_file in a self-consistent manner.  It
   !! is good practice to check that your model output incident stellar flux (FDS)
   !! looks correct for your assumed dirunal cycle.
   !!
   !! exo_sdays is the length of the sidereal period in seconds.
   !! exo_ndays is a scaler given in units of Earth days
   !! exo_porb is the orbital period, optional input used to determine
   !!         the sidereal period, exo_sdays, for asynchronous rotators
   !!
   !! if (do_exo_synchronous = .true.) synchronous rotation is assumed. The
   !! zenith angle is fixed at 180 deg longitude, and the Coriolis parameter is
   !! set via, exo_sdays [sec] = 86400.0 [sec/Earth day] * exo_ndays [Earth days].
   !! There is no diurnal cycle.
   !!
   !! if (do_exo_synchronous = .false.) non-synchronous rotation occurs.  The
   !! Coriolis parameter is set via exo_sdays [sec], and the diurnal cycle
   !! (length of solar day) is then set explicitly by exo_ndays [Earth days].
   !! Note, that the length of the diurnal period does not equal to the
   !! sidereal period!  Take care in setting exo_ndays and exo_sdays!
   !!
   !! See examples below.

   !! Generic
   !!real(r8), public, parameter :: exo_planet_radius   = 6.37122e6_R8 !! radius ~ m
   !!real(r8), public, parameter :: exo_surface_gravity = 9.80616_R8          !! gravity ~ m/s^2
   !!real(r8), public, parameter :: exo_ndays  = 1.0_R8                    !! scaler to number of Earth days.
   !!real(r8), public, parameter :: exo_porb = 365.                        !! orbital period, for obliquity cycle, and optionally for exo_sday
   !!real(r8), public, parameter :: exo_sday = 86164.0_r8                !! sidereal period Earth
   !!real(r8), public, parameter :: exo_sday = 86400.0_r8 * exo_ndays    !! sidereal period, for synchronous rotator
   !!real(r8), public, parameter :: exo_sday = 86400.0_r8 * exo_ndays / (1._r8 + exo_ndays/exo_porb)  !! sidereal period [sec]

   !! Mars Orbital
   real(r8), public, parameter :: exo_planet_radius   = 3.38992e6_R8     !! radius ~ m
   real(r8), public, parameter :: exo_surface_gravity = 3.711_R8         !! gravity ~ m/s^2
   real(r8), public, parameter :: exo_diurnal = 88800.0_R8               !! Length of diurnal period, solar-day ~ s
   real(r8), public, parameter :: exo_ndays  = exo_diurnal/86400.0_R8    !! scaler to number of Earth days
   real(r8), public, parameter :: exo_porb = 687.0_R8                    !! orbital period in Earth Days, for obliquity/eccentricity cycles
   real(r8), public, parameter :: exo_sday = 88642.663_R8                !! sidereal period

   !! Examples
   !! Earth
   !!real(r8), public, parameter :: exo_planet_radius   = 6.37122e6_R8     !! radius ~ m
   !!real(r8), public, parameter :: exo_surface_gravity = 9.80616_R8       !! gravity ~ m/s^2
   !!real(r8), public, parameter :: exo_ndays  = 1.0_R8                    !! scaler to number of Earth days.
   !!real(r8), public, parameter :: exo_porb = 365.0_R8
   !!real(r8), public, parameter :: exo_sday = 86164.0_R8                  !! sidereal period [sec], for Earth value = 86164.0

   !! Earth - slow asynchronous rotator
   !!real(r8), public, parameter :: exo_planet_radius   = 6.37122e6_R8      !! radius ~ m
   !!real(r8), public, parameter :: exo_surface_gravity = 9.80616_R8        !! gravity ~ m/s^2
   !!real(r8), public, parameter :: exo_ndays  = 10.0_R8                    !! scaler to number of Earth days.
   !!real(r8), public, parameter :: exo_porb = 365.0_R8                     !! orbital period
   !!real(r8), public, parameter :: exo_sday = 86400.0_r8 * exo_ndays / (1._r8 + exo_ndays/exo_porb)  !! sidereal period [sec]

   !! Trappist-1e  (Gillon et al. 2017)  --  synchronous rotator
   !!real(r8), public, parameter :: exo_planet_radius    = 5.84878e6_R8    !! radius ~ m
   !!real(r8), public, parameter :: exo_surface_gravity  = 7.22925_R8      !! gravity ~ m/s^2
   !!real(r8), public, parameter :: exo_ndays  = 6.099615_r8               !! scaler to number of Earth days.
   !!real(r8), public, parameter :: exo_porb = exo_ndays                   !! orbital period
   !!real(r8), public, parameter :: exo_sday = 86400.0_r8 * exo_ndays      !! sidereal period, synchronous rotator

   !! Trappist-1f  (Gillon et al. 2017)  --  synchronous rotator
   !!real(r8), public, parameter :: exo_planet_radius    = 6.65792e6_R8    !! radius ~ m
   !!real(r8), public, parameter :: exo_surface_gravity  = 6.11876_R8      !! gravity ~ m/s^2
   !!real(r8), public, parameter :: exo_ndays  = 9.206690_r8               !! scaler to number of Earth days.
   !!real(r8), public, parameter :: exo_porb = exo_ndays                   !! orbital period
   !!real(r8), public, parameter :: exo_sday = 86400.0_r8 * exo_ndays      !! sidereal period, synchronous rotator

   !! if set user_nl_cpl::orb_iyear = -1
   !! Modern Mars
   !real(r8), public, parameter :: exo_eccen = 0.0934_r8  ! eccentricity
   !real(r8), public, parameter :: exo_obliq = 25.19_r8   ! obliquity [degrees]
   !real(r8), public, parameter :: exo_mvelp = 70.90_r8   ! vernal equinox

   !!
   real(r8), public, parameter :: exo_eccen = 0.0_r8  ! eccentricity
   real(r8), public, parameter :: exo_obliq = 25.0_r8   ! obliquity [degrees]
   real(r8), public, parameter :: exo_mvelp = 70.90_r8   ! vernal equinox


   !! ============== STELLAR OPTIONS ============== !!
   !! SOLAR CONSTANT
 !!  real(r8), public, parameter :: exo_scon = 586.2_r8         ! Solar constant (W m-2)  ! Modern Mars
   real(r8), public, parameter :: exo_scon = 441.1_r8         ! Solar constant (W m-2)  ! Ancient Mars (75%)

   ! SOLAR SPECTRAL FILE
   !! Make sure solar file matches spectral intervals for selected RT configuration !!
 !  character(len=256), public, parameter :: exo_solar_file = '/projects/wolfet/models/ExoRT/data/solar/G2V_SUN_n68.nc'
   character(len=256), public, parameter :: exo_solar_file = '/discover/nobackup/etwolf/models/ExoRT/data/solar/G2V_SUN_n68.nc'


   !! ============== ATMOSPHERIC CONSTITUENT PARAMETERS ============== !!
   !! Activated only if (do_exo_atmconst = .true.)
   !! Must create matching initial conditions file (ncdata) !!
   real(r8), public, parameter :: exo_n2bar = 0.0_r8                ! N2 inventory (bar)
   real(r8), public, parameter :: exo_h2bar = 0.0_r8                ! H2 inventory (bar)
   real(r8), public, parameter :: exo_co2bar = 0.0061_r8               ! CO2 inventory (bar)
   real(r8), public, parameter :: exo_c2h6bar = 0.0_r8                        ! C2H6 inventory (bar)
   real(r8), public, parameter :: exo_ch4bar = 0.0_r8               ! CH4 inventory (bar)
   real(r8), public, parameter :: exo_pstd = (exo_n2bar + exo_h2bar + exo_co2bar + exo_ch4bar + exo_c2h6bar)*1.0e5  ! total pressure (Pascals)


   !! ============== OCEAN ALBEDO CONSTANTS ============== !!
   real(r8), public, parameter :: exo_albdif = 0.06 ! 60 deg reference albedo, diffuse (default = 0.06)
   real(r8), public, parameter :: exo_albdir = 0.06 ! 60 deg reference albedo, direct  (default = 0.07)


   !! ============== LAND ALBEDO CONSTANTS ============== !!
   !! Used for soil_color = 21 in the land model (if active)
   !! The input surface data set (fsurdat) contains the soil_colors
   real(r8), public, parameter :: exo_lnd_albvis_dry = 0.20    ! land albedo, visible, dry soil
   real(r8), public, parameter :: exo_lnd_albifr_dry = 0.20    ! land albedo, infrared, dry soil
   real(r8), public, parameter :: exo_lnd_albvis_sat = 0.20    ! land albedo, visible, saturated soil
   real(r8), public, parameter :: exo_lnd_albifr_sat = 0.20    ! land albedo, infrared, saturated soil
   !! land ice/glacier albedo
   real(r8), public, parameter :: exo_lnd_albglac_vis = 0.55    ! land ice, visible
   real(r8), public, parameter :: exo_lnd_albglac_ifr = 0.55    ! land ice, infrared


   !! ============== Land Surface Constants ============== !!
   real(r8), public, parameter :: exo_soilw   = 0.1_r8       ! Volumetric soil water content.
   real(r8), public, parameter :: exo_soilwn  = 0.0_r8      ! Volumetric soil water content.
   real(r8), public, parameter :: exo_soilws  = 0.0_r8      ! Volumetric soil water content.
   real(r8), public, parameter :: exo_soild   = 1400.0_r8    ! avg density of Martian soil (kg/m3)
   real(r8), public, parameter :: exo_soilbd  = 1400.0_r8    ! avg bulk density of Martian soil (3060 is K.Kossacki 2000) (kg/m3)
   real(r8), public, parameter :: exo_soilcp  = 627.9_r8     ! Martian soil heat capacity ~J/kg/K (Mellon 2000 = 627.9) ! (Zent 1993 = 820)
   real(r8), public, parameter :: exo_soilpor = 0.3_r8       !(SHR_CONST_SOILD/SHR_CONST_SOILBD)           ! 1 - Martian soil porosity
   real(r8), public, parameter :: exo_soilhz  = 1.e-3_r8     ! Martian soil Hertz factor (K.Kossacki 2000)
   real(r8), public, parameter :: exo_soiltk  = 0.04_r8      ! Typical Martian soil thermal conductivity for co2 calc
   real(r8), public, parameter :: exo_thinfac = 1.0_r8       ! Factor to change the thermal inertia to match obs.

   ! there are proposed but not used yet; present constant values are set in the surfdata file
   real(r8), public, parameter :: exo_soil_roughness = 0.01_r8 ! m, constant soil roughness
   real(r8), public, parameter :: exo_soil_ti        = 250.0_r8 ! J m-2 s-1/2 K-1, soil thermal inertia

   !!================ other mars things ================== !!
   real(r8), public, parameter :: exo_tkair = 0.015_r8   ! Thermal conductivity of air at STP ~ W/m/K (CRC handbook. hbcpnetbase.com)

   !! ============== CO2 Ice constants  ============== !!
   real(r8), public, parameter :: exo_densityco2fr  =  910.0_r8   ! Density of CO2 frost (Kg/m3) (D.Smith 2001)
 !  real(r8), public, parameter :: exo_co2latsub     =  7.76e5_r8      ! latent heat of sublimation ~ J/kg   ! Richard's model
   real(r8), public, parameter :: exo_co2latsub     =  5.9e5_r8      ! latent heat of sublimation ~ J/kg    ! Used everywhere else
   real(r8), public, parameter :: exo_co2_alvis     =  0.50_r8    !Forget_2013  ! 0.60_r8    ! Visible albedo of CO2 snow (Hourdin 1993)
   real(r8), public, parameter :: exo_co2_alnir     =  0.50_r8    !Forget_2013  !0.60_r8    ! Near-IR albedo of CO2 snow
   real(r8), public, parameter :: exo_co2_als       =  0.80_r8    ! albedo of CO2 snow South (Hourdin 1993)
   real(r8), public, parameter :: exo_co2_aln       =  0.60_r8    ! albedo of CO2 snow North
   real(r8), public, parameter :: exo_co2_emis      =  0.85_r8    !Forget_2013 !0.8_r8             ! Emissivity of CO2 ice (Hourdin 1993)
   real(r8), public, parameter :: exo_densityco2ice =  1620._r8   ! Density of CO2 ice (kg/m3) (this is what LMD uses for everything)
   real(r8), public, parameter :: exo_cpco2ice      =  1000._r8   ! specific heat of co2 ice [J kg-1 K-1]
   real(r8), public, parameter :: exo_co2ice_ti     = 1000.0_r8   ! J m-2 s-1/2 K-1, co2 ice thermal inertia
   real(r8), public, parameter :: exo_co2ice_thick  = 0.05_r8     ! [m] CO2 ice thickness required to insulate underlying layers

   !! ============== FUNDAMENTAL CONSTANTS NEEDED USED BELOW ============== !!
   !! note there is some duplication with physconst.F90, keep private

   ! molecular weights
   real(r8), parameter :: mwn2 = 28._r8
   real(r8), parameter :: mwh2 = 2._r8
   real(r8), parameter :: mwco2 = 44._r8
   real(r8), parameter :: mwch4 = 16._r8
   real(r8), parameter :: mwc2h6 = 30._r8

   ! specific heat of dry air
   real(r8), parameter :: cpn2 = 1.039e3_r8
   real(r8), parameter :: cph2 = 14.32e3_r8
   real(r8), parameter :: cpch4 = 2.226e3
   real(r8), parameter :: cpc2h6 = 1.756e3

   ! CO2 values change non-negligible with temperature
   ! may need to modify this based on atmosphere.
   real(r8), parameter :: cpco2 = 0.735e3_r8    ! 200 K    ! mars models use this
   !real(r8), parameter :: cpco2 = 0.763e3_r8    ! 225 K
   !real(r8), parameter :: cpco2 = 0.791e3_r8    ! 250 K
   !real(r8), parameter :: cpco2 = 0.819e3_r8    ! 275 K
   !real(r8), parameter :: cpco2 = 0.846e3_r8    ! 300 K


   !! DERIVED CONSTANTS -- DO NOT MODIFY
   !! automatically calculated from above inputs in bar
   ! dry volume mixing ratios  kg/kmole
   real(r8), public, parameter :: exo_n2vmr = exo_n2bar / (exo_pstd/1.0e5)
   real(r8), public, parameter :: exo_h2vmr = exo_h2bar / (exo_pstd/1.0e5)
   real(r8), public, parameter :: exo_co2vmr = exo_co2bar / (exo_pstd/1.0e5)
   real(r8), public, parameter :: exo_ch4vmr = exo_ch4bar / (exo_pstd/1.0e5)
   real(r8), public, parameter :: exo_c2h6vmr = exo_c2h6bar / (exo_pstd/1.0e5)

   real(r8), public, parameter :: &   ! molecular weight of dry air
             exo_mwdair = exo_n2vmr*mwn2 + exo_h2vmr*mwh2 + exo_co2vmr*mwco2 + exo_ch4vmr*mwch4 + exo_c2h6vmr*mwc2h6

   !! dry mass mixing ratios
   real(r8), public, parameter :: exo_n2mmr = exo_n2vmr * mwn2/exo_mwdair
   real(r8), public, parameter :: exo_h2mmr = exo_h2vmr * mwh2/exo_mwdair
   real(r8), public, parameter :: exo_co2mmr = exo_co2vmr * mwco2/exo_mwdair
   real(r8), public, parameter :: exo_ch4mmr = exo_ch4vmr * mwch4/exo_mwdair
   real(r8), public, parameter :: exo_c2h6mmr = exo_c2h6vmr * mwc2h6/exo_mwdair

   real(r8), public, parameter :: &   ! specific heat of dry, air J/kg/K
            exo_cpdair = exo_n2mmr*cpn2 + exo_h2mmr*cph2 + exo_co2mmr*cpco2 + exo_ch4mmr*cpch4 + exo_c2h6mmr*cpc2h6

end module exoplanet_mod
